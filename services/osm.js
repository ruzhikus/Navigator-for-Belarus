// ==================================================
// ะกะตัะฒะธั ะดะปั ะฟะพะปััะตะฝะธั ัะฟะธัะบะฐ ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะตะน ัะตัะตะท OpenStreetMap.
// ะัะฟะพะปัะทัะตั Overpass API ะดะปั ะฟะพะธัะบะฐ ะพะฑัะตะบัะพะฒ ะฒ ัะฐะดะธััะต 5 ะบะผ ะพั ะทะฐะดะฐะฝะฝัั ะบะพะพัะดะธะฝะฐั.
// ะะพะทะฒัะฐัะฐะตั ัะฟะธัะพะบ ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะตะน (ะผะฐะบั. 4) ั ะธะบะพะฝะบะฐะผะธ ะธ ะฝะฐะทะฒะฐะฝะธัะผะธ.
// ะ ัะปััะฐะต ะพัะธะฑะบะธ ะธะปะธ ะพััััััะฒะธั ะดะฐะฝะฝัั ะฒะพะทะฒัะฐัะฐะตั ััะฐะฝะดะฐััะฝัะน ัะฟะธัะพะบ.
// ==================================================

const axios = require('axios');

// ะัะตั ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะธ (ะผัะทะตะธ, ะฟะฐะผััะฝะธะบะธ, ััะฐะผั, ะฟะฐัะบะธ) ะฒะพะบััะณ ัะบะฐะทะฐะฝะฝัั ะบะพะพัะดะธะฝะฐั.
// ะัะธะฝะธะผะฐะตั ัะธัะพัั, ะดะพะปะณะพัั ะธ ัะทัะบ ะฟะพะปัะทะพะฒะฐัะตะปั.
// ะะพะทะฒัะฐัะฐะตั ัััะพะบั ัะพ ัะฟะธัะบะพะผ ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะตะน (ะบะฐะถะดะฐั ั ะฝะพะฒะพะน ัััะพะบะธ).
async function getAttractionsFromOSM(lat, lon, lang) {
    try {
        // Overpass QL ะทะฐะฟัะพั: ะธัะตะผ ะผัะทะตะธ, ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะธ, ะธััะพัะธัะตัะบะธะต ะพะฑัะตะบัั, ััะฐะผั, ะฟะฐัะบะธ ะฒ ัะฐะดะธััะต 5 ะบะผ
        const query = `
            [out:json];
            (
                node["tourism"~"museum|attraction"](around:5000,${lat},${lon});
                node["historic"](around:5000,${lat},${lon});
                node["amenity"="place_of_worship"](around:5000,${lat},${lon});
                node["leisure"="park"](around:5000,${lat},${lon});
            );
            out body;
        `;
        const { data } = await axios.post('https://overpass-api.de/api/interpreter', `data=${encodeURIComponent(query)}`, {
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'User-Agent': 'BelarusTravelBot/1.0'
            },
            timeout: 15000
        });

        if (data.elements?.length) {
            // ะคะธะปััััะตะผ ะพะฑัะตะบัั ั ะฝะฐะทะฒะฐะฝะธัะผะธ ะธ ะฑะตััะผ ะฝะต ะฑะพะปะตะต 4, ััะพะฑั ะพัะฒะตั ะฝะต ะฑัะป ัะปะธัะบะพะผ ะดะปะธะฝะฝัะผ
            const attractions = data.elements
                .filter(e => e.tags?.name)
                .slice(0, 4)
                .map(e => {
                    // ะะฟัะตะดะตะปัะตะผ ัะธะฟ ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะธ ะฝะฐ ะฝัะถะฝะพะผ ัะทัะบะต
                    const type = e.tags.tourism === 'museum' ? '๐๏ธ ะัะทะตะน' :
                                 e.tags.historic === 'castle' ? (lang === 'bel' ? '๐ฐ ะะฐะผะฐะบ' : '๐ฐ ะะฐะผะพะบ') :
                                 e.tags.historic === 'monument' ? (lang === 'bel' ? '๐ฟ ะะพะผะฝัะบ' : '๐ฟ ะะฐะผััะฝะธะบ') :
                                 e.tags.amenity === 'place_of_worship' ? 'โช ะฅัะฐะผ' :
                                 e.tags.leisure === 'park' ? '๐ณ ะะฐัะบ' :
                                 (lang === 'bel' ? '๐ ะกะปะฐะฒััะฐััั' : '๐ ะะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััั');
                    return `${type} "${e.tags.name}"`;
                });
            if (attractions.length) return attractions.join('\n');
        }
    } catch {
        // ะ ัะปััะฐะต ะพัะธะฑะบะธ (ัะตัะตะฒะพะน, ัะฐะนะผะฐัั, ะฟัััะพะน ะพัะฒะตั) ะฝะธัะตะณะพ ะฝะต ะดะตะปะฐะตะผ โ ะฟะตัะตะนะดัะผ ะบ ััะฐะฝะดะฐััะฝะพะผั ัะฟะธัะบั
    }
    // ะกัะฐะฝะดะฐััะฝัะน ัะฟะธัะพะบ ะดะพััะพะฟัะธะผะตัะฐัะตะปัะฝะพััะตะน, ะตัะปะธ OSM ะฝะต ะดะฐะป ัะตะทัะปััะฐัะพะฒ
    return lang === 'bel'
        ? '๐ ะฆัะฝััะฐะปัะฝะฐั ะฟะปะพััะฐ\n๐๏ธ ะัััะพะฒั ะผัะทะตะน\n๐ณ ะะฐัะฐะดัะบั ะฟะฐัะบ'
        : '๐ ะฆะตะฝััะฐะปัะฝะฐั ะฟะปะพัะฐะดั\n๐๏ธ ะะตััะฝัะน ะผัะทะตะน\n๐ณ ะะพัะพะดัะบะพะน ะฟะฐัะบ';
}

module.exports = getAttractionsFromOSM;