// ==================================================
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é.
// –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:
// 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≥–æ—Ä–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ë–µ–ª–∞—Ä—É—Å–∏.
// 2. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞.
// 3. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç: –≥–æ–¥ –æ—Å–Ω–æ–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–≥–æ–¥—É.
// 4. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
// –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
// ==================================================

const axios = require('axios'); // –î–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ (–≥–µ–æ–∫–æ–¥–∏–Ω–≥)
const TEXTS = require('../constants/texts');
const { isCityInBelarus, getWeather } = require('../services/weather');
const { getOfficialYear, getDescription } = require('../services/wikipedia');
const getAttractionsFromOSM = require('../services/osm');
const { WEATHER_KEY } = require('../config/token'); // –ö–ª—é—á –¥–ª—è –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞.
// –ü—Ä–∏–Ω–∏–º–∞–µ—Ç ID —á–∞—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ (–≤–≤–µ–¥—ë–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º), —è–∑—ã–∫ –∏ —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞.
async function handleCitySearch(chatId, cityInput, lang, bot) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é..." –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ ID, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏—Ç—å
    const waitMsg = await bot.sendMessage(chatId, TEXTS[lang].searching);
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–æ—Ä–æ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ë–µ–ª–∞—Ä—É—Å–∏
        if (!(await isCityInBelarus(cityInput))) throw new Error('not_found');

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ –≥–µ–æ–∫–æ–¥–∏–Ω–≥ OpenWeather
        const geo = await axios.get(`http://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(cityInput)}&limit=1&appid=${WEATHER_KEY}`);
        if (!geo.data.length) throw new Error('not_found');
        const { lat, lon, local_names } = geo.data[0];
        const nameRU = local_names?.ru || cityInput; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å (–¥–ª—è —Å—Å—ã–ª–æ–∫ –∏ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è)

        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ: –≥–æ–¥ –æ—Å–Ω–æ–≤–∞–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–∏–µ, –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–≥–æ–¥—É
        const [year, description, attractions, weather] = await Promise.all([
            getOfficialYear(nameRU, lang),
            getDescription(nameRU, lang),
            getAttractionsFromOSM(lat, lon, lang),
            getWeather(lat, lon)
        ]);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã (–ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        let weatherDesc = weather.weather[0].description;
        if (lang === 'bel') {
            // –°–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ–≥–æ–¥–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–π
            const wMap = {
                '—è—Å–Ω–æ': '—è—Å–Ω–∞',
                '–Ω–µ–±–æ–ª—å—à–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å': '–Ω–µ–≤—è–ª—ñ–∫–∞—è –≤–æ–±–ª–∞—á–Ω–∞—Å—Ü—å',
                '–æ–±–ª–∞—á–Ω–æ —Å –ø—Ä–æ—è—Å–Ω–µ–Ω–∏—è–º–∏': '–≤–æ–±–ª–∞—á–Ω–∞ –∑ –ø—Ä–∞—è—Å–Ω–µ–Ω–Ω—è–º—ñ',
                '–ø–∞—Å–º—É—Ä–Ω–æ': '–ø–∞—Ö–º—É—Ä–Ω–∞',
                '–¥–æ–∂–¥—å': '–¥–æ–∂–¥–∂',
                '–Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å': '–Ω–µ–≤—è–ª—ñ–∫—ñ –¥–æ–∂–¥–∂',
                '—Å–Ω–µ–≥': '—Å–Ω–µ–≥',
                '–Ω–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥': '–Ω–µ–≤—è–ª—ñ–∫—ñ —Å–Ω–µ–≥',
                '—Ç—É–º–∞–Ω': '—Ç—É–º–∞–Ω',
                '–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å': '–ø–µ—Ä–∞–º–µ–Ω–Ω–∞—è –≤–æ–±–ª–∞—á–Ω–∞—Å—Ü—å'
            };
            weatherDesc = wMap[weatherDesc] || weatherDesc; // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
        }

        // –°—Å—ã–ª–∫–∞ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã —Å –æ—Ç–µ–ª—è–º–∏ –∏ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º–∏
        const mapLink = `https://yandex.by/maps/?text=${encodeURIComponent('–û—Ç–µ–ª–∏ –∏ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ' + nameRU)}`;

        // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —è–∑—ã–∫–∞
        const msg = lang === 'bel'
            ? `üèôÔ∏è *${nameRU.toUpperCase()}*\nüìÖ *–ì–æ–¥ –∑–∞—Å–Ω–∞–≤–∞–Ω–Ω—è:* ${year}\n\nüìú *–ü—Ä–∞ –≥–æ—Ä–∞–¥:* ${description}\n\nüèõÔ∏è *–ö–£–î–´ –°–•–ê–î–ó–Ü–¶–¨:*\n${attractions}\n\nüå°Ô∏è *–ù–∞–¥–≤–æ—Ä'–µ:* ${Math.round(weather.main.temp)}¬∞C, ${weatherDesc}\n\nüè® [–ì–ê–°–¶–Ü–ù–Ü–¶–´ –Ü –ö–ê–†–¢–ê](${mapLink})`
            : `üèôÔ∏è *${nameRU.toUpperCase()}*\nüìÖ *–ì–æ–¥ –æ—Å–Ω–æ–≤–∞–Ω–∏—è:* ${year}\n\nüìú *–û –≥–æ—Ä–æ–¥–µ:* ${description}\n\nüèõÔ∏è *–ö–£–î–ê –°–•–û–î–ò–¢–¨:*\n${attractions}\n\nüå°Ô∏è *–ü–æ–≥–æ–¥–∞:* ${Math.round(weather.main.temp)}¬∞C, ${weatherDesc}\n\nüè® [–û–¢–ï–õ–ò –ò –ö–ê–†–¢–ê](${mapLink})`;

        // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ò—â—É..." –Ω–∞ –≥–æ—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
        await bot.editMessageText(msg, {
            chat_id: chatId,
            message_id: waitMsg.message_id,
            parse_mode: 'Markdown',
            disable_web_page_preview: false // –ü–æ–∑–≤–æ–ª—è–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–∫–∏
        });
    } catch (err) {
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ (–≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å API) –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const errText = err.message === 'not_found' ? TEXTS[lang].cityNotFound : TEXTS[lang].error;
        await bot.editMessageText(errText, { chat_id: chatId, message_id: waitMsg.message_id });
    }
}

module.exports = handleCitySearch;